#!/usr/bin/env node

const { execSync } = require('child_process');
const program = require('commander');
const fs = require('fs');
const { resolve } = require('path');

program
  .command('init')
  .option('-l, --lib-only', 'Only install library helpers')
  .action((cmd) => {
    const libOnly = cmd.libOnly;
    const source = resolve(__dirname, '..');
    const destination = process.cwd();

    if (source === destination) {
      console.log('Cannot install into itself.');
      return;
    }

    console.log(`Init ${source} -> ${destination}`);

    function copy(file) {
      const toFile = file.endsWith('_publish') ? file.slice(0, -8) : file;
      console.log(`Copying ${toFile}...`)
      fs.copyFileSync(resolve(source, file), resolve(destination, toFile));
    }

    copy('.editorconfig');
    copy('.gitignore_publish');
    copy('.npmignore_publish');
    copy('jest.config.js');
    if (!libOnly) {
      copy('nodemon.json');
    }
    copy('tsconfig.json');
    copy('tslint.json');

    try {
      fs.mkdirSync(resolve(destination, 'src'));
    } catch{ }
    try {
      fs.mkdirSync(resolve(destination, 'test'));
    } catch{ }

    const package = JSON.parse(
      fs.readFileSync(resolve(destination, 'package.json')).toString(),
    );
    Object.assign(package, {
      main: './dist/index.js',
      types: './src/index.ts',
    });
    package.scripts = Object.assign(package.scripts || {}, {
      build: 'rm -rf dist && npx tsc --outDir dist --sourceMap',
      lint: 'npx tslint --project tslint.json -t verbose',
      prepublishOnly: 'npm run lint && npm run build && npm version patch',
      test: 'npx jest --coverage',
    });
    if (!libOnly) {
      package.scripts = Object.assign(package.scripts || {}, {
        start: 'node -r ts-node/register src/index.ts',
        watch: 'npx nodemon',
      });
    }

    fs.writeFileSync(
      resolve(destination, 'package.json'),
      JSON.stringify(package, null, 2),
      'utf-8',
    );

    execSync('npm i -D @types/jest @types/node jest tslint typescript nodemon ts-node ts-jest');

    console.log('. Done');
  });

program.parse(process.argv);
